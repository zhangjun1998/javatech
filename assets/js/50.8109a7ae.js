(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{286:function(s,t,a){"use strict";a.r(t);var e=a(2),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"elasticsearch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch"}},[s._v("#")]),s._v(" Elasticsearch")]),s._v(" "),a("blockquote",[a("p",[a("strong",[a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch"),a("OutboundLink")],1),s._v(" 是一个分布式、RESTful 风格的搜索和数据分析引擎")]),s._v("，能够解决不断涌现出的各种用例。 作为 Elastic Stack 的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch"),a("OutboundLink")],1),s._v(" 基于搜索库 "),a("a",{attrs:{href:"https://github.com/apache/lucene-solr",target:"_blank",rel:"noopener noreferrer"}},[s._v("Lucene"),a("OutboundLink")],1),s._v(" 开发。ElasticSearch 隐藏了 Lucene 的复杂性，提供了简单易用的 REST API / Java API 接口（另外还有其他语言的 API 接口）。")]),s._v(" "),a("p",[a("em",[s._v("以下简称 ES")]),s._v("。")])]),s._v(" "),a("h2",{attrs:{id:"一、elasticsearch-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、elasticsearch-简介"}},[s._v("#")]),s._v(" 一、Elasticsearch 简介")]),s._v(" "),a("h3",{attrs:{id:"_1-1-什么是-elasticsearch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是-elasticsearch"}},[s._v("#")]),s._v(" 1.1. 什么是 Elasticsearch")]),s._v(" "),a("p",[a("strong",[a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch"),a("OutboundLink")],1),s._v(" 是一个分布式、RESTful 风格的搜索和数据分析引擎")]),s._v("，能够解决不断涌现出的各种用例。 作为 Elastic Stack 的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch"),a("OutboundLink")],1),s._v(" "),a("strong",[s._v("基于搜索库 "),a("a",{attrs:{href:"https://github.com/apache/lucene-solr",target:"_blank",rel:"noopener noreferrer"}},[s._v("Lucene"),a("OutboundLink")],1),s._v(" 开发")]),s._v("。ElasticSearch 隐藏了 Lucene 的复杂性，提供了简单易用的 REST API / Java API 接口（另外还有其他语言的 API 接口）。")]),s._v(" "),a("p",[s._v("ElasticSearch 可以视为一个文档存储，它"),a("strong",[s._v("将复杂数据结构序列化为 JSON 存储")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("ElasticSearch 是近乎于实时的全文搜素")]),s._v("，这是指：")]),s._v(" "),a("ul",[a("li",[s._v("从写入数据到数据可以被搜索，存在较小的延迟（大概是 1s）")]),s._v(" "),a("li",[s._v("基于 ES 执行搜索和分析可以达到秒级")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-核心概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-核心概念"}},[s._v("#")]),s._v(" 1.2. 核心概念")]),s._v(" "),a("h4",{attrs:{id:"_1-2-1-index"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-index"}},[s._v("#")]),s._v(" 1.2.1. Index")]),s._v(" "),a("p",[a("strong",[s._v("可以认为是文档（document）的优化集合。")])]),s._v(" "),a("p",[s._v("ES 会为所有字段建立索引，经过处理后写入一个反向索引（Inverted Index）。查找数据的时候，直接查找该索引。")]),s._v(" "),a("p",[s._v("所以，ES 数据管理的顶层单位就叫做 Index（索引）。它是单个数据库的同义词。每个 Index （即数据库）的名字必须是小写。")]),s._v(" "),a("h4",{attrs:{id:"_1-2-2-document"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-document"}},[s._v("#")]),s._v(" 1.2.2. Document")]),s._v(" "),a("p",[s._v("Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。")]),s._v(" "),a("p",[s._v("每个 "),a("strong",[a("code",[s._v("文档（document）")])]),s._v(" 都是字段（field）的集合。")]),s._v(" "),a("p",[s._v("Document 使用 JSON 格式表示，下面是一个例子。")]),s._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"张三"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"title"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"数据库管理"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("同一个 Index 里面的 Document，不要求有相同的结构（scheme），但是最好保持相同，这样有利于提高搜索效率。")]),s._v(" "),a("h4",{attrs:{id:"_1-2-3-field"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-field"}},[s._v("#")]),s._v(" 1.2.3. Field")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("字段（field）")])]),s._v(" 是包含数据的键值对。")]),s._v(" "),a("p",[s._v("默认情况下，Elasticsearch 对每个字段中的所有数据建立索引，并且每个索引字段都具有专用的优化数据结构。")]),s._v(" "),a("h4",{attrs:{id:"_1-2-4-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-4-type"}},[s._v("#")]),s._v(" 1.2.4. Type")]),s._v(" "),a("p",[s._v("每个索引里可以有一个或者多个类型（type）。"),a("code",[s._v("类型（type）")]),s._v(" 是 index 的一个逻辑分类。")]),s._v(" "),a("p",[s._v("不同的 Type 应该有相似的结构（schema），举例来说，"),a("code",[s._v("id")]),s._v("字段不能在这个组是字符串，在另一个组是数值。这是与关系型数据库的表的"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/guide/current/mapping.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("一个区别"),a("OutboundLink")],1),s._v("。性质完全不同的数据（比如"),a("code",[s._v("products")]),s._v("和"),a("code",[s._v("logs")]),s._v("）应该存成两个 Index，而不是一个 Index 里面的两个 Type（虽然可以做到）。")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：根据"),a("a",{attrs:{href:"https://www.elastic.co/blog/index-type-parent-child-join-now-future-in-elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("规划"),a("OutboundLink")],1),s._v("，Elastic 6.x 版只允许每个 Index 包含一个 Type，7.x 版将会彻底移除 Type。")])]),s._v(" "),a("h4",{attrs:{id:"_1-2-5-shard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-5-shard"}},[s._v("#")]),s._v(" 1.2.5. Shard")]),s._v(" "),a("p",[s._v("当单台机器不足以存储大量数据时，Elasticsearch 可以将一个索引中的数据切分为多个 "),a("strong",[a("code",[s._v("分片（shard）")])]),s._v(" 。 "),a("strong",[a("code",[s._v("分片（shard）")])]),s._v(" 分布在多台服务器上存储。有了 shard 就可以横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能。每个 shard 都是一个 lucene index。")]),s._v(" "),a("h4",{attrs:{id:"_1-2-6-replica"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-6-replica"}},[s._v("#")]),s._v(" 1.2.6. Replica")]),s._v(" "),a("p",[s._v("任何一个服务器随时可能故障或宕机，此时 shard 可能就会丢失，因此可以为每个 shard 创建多个 "),a("strong",[a("code",[s._v("副本（replica）")])]),s._v("。replica 可以在 shard 故障时提供备用服务，保证数据不丢失，多个 replica 还可以提升搜索操作的吞吐量和性能。primary shard（建立索引时一次设置，不能修改，默认 5 个），replica shard（随时修改数量，默认 1 个），默认每个索引 10 个 shard，5 个 primary shard，5 个 replica shard，最小的高可用配置，是 2 台服务器。")]),s._v(" "),a("h2",{attrs:{id:"二、rest-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、rest-api"}},[s._v("#")]),s._v(" 二、REST API")]),s._v(" "),a("blockquote",[a("p",[s._v("REST API 最详尽的文档应该参考："),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("ES 官方 REST API"),a("OutboundLink")],1)])]),s._v(" "),a("h3",{attrs:{id:"_3-1-索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-索引"}},[s._v("#")]),s._v(" 3.1. 索引")]),s._v(" "),a("p",[s._v("新建 Index，可以直接向 ES 服务器发出 "),a("code",[s._v("PUT")]),s._v(" 请求。")]),s._v(" "),a("h4",{attrs:{id:"_3-1-1-创建索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-创建索引"}},[s._v("#")]),s._v(" 3.1.1. 创建索引")]),s._v(" "),a("p",[s._v("示例：直接创建索引")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user'")]),s._v("\n")])])]),a("p",[s._v("服务器返回一个 JSON 对象，里面的 "),a("code",[s._v("acknowledged")]),s._v(" 字段表示操作成功。")]),s._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"acknowledged"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shards_acknowledged"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("示例：创建索引时指定配置")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n    "settings" : {\n        "index" : {\n            "number_of_shards" : 3,\n            "number_of_replicas" : 2\n        }\n    }\n}\'')]),s._v("\n")])])]),a("p",[s._v("示例：创建索引时指定 "),a("code",[s._v("mappings")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n    "settings" : {\n        "index" : {\n            "number_of_shards" : 3,\n            "number_of_replicas" : 2\n        }\n    }\n}\'')]),s._v("\n")])])]),a("h4",{attrs:{id:"_3-1-2-删除索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-删除索引"}},[s._v("#")]),s._v(" 3.1.2. 删除索引")]),s._v(" "),a("p",[s._v("然后，我们可以通过发送 "),a("code",[s._v("DELETE")]),s._v(" 请求，删除这个 Index。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X DELETE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user'")]),s._v("\n")])])]),a("h4",{attrs:{id:"_3-1-3-查看索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-查看索引"}},[s._v("#")]),s._v(" 3.1.3. 查看索引")]),s._v(" "),a("p",[s._v("可以通过 GET 请求查看索引信息")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X GET "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user'")]),s._v("\n")])])]),a("h4",{attrs:{id:"_3-1-4-打开-关闭索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-4-打开-关闭索引"}},[s._v("#")]),s._v(" 3.1.4. 打开/关闭索引")]),s._v(" "),a("p",[s._v("通过在 "),a("code",[s._v("POST")]),s._v(" 中添加 "),a("code",[s._v("_close")]),s._v(" 或 "),a("code",[s._v("_open")]),s._v(" 可以打开、关闭索引。\n关闭索引")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/_close'")]),s._v("\n")])])]),a("p",[s._v("打开索引")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/_open'")]),s._v("\n")])])]),a("h3",{attrs:{id:"_3-2-文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-文档"}},[s._v("#")]),s._v(" 3.2. 文档")]),s._v(" "),a("h4",{attrs:{id:"_3-2-1-新增记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-新增记录"}},[s._v("#")]),s._v(" 3.2.1. 新增记录")]),s._v(" "),a("p",[s._v("向指定的 "),a("code",[s._v("/Index/type")]),s._v(" 发送 PUT 请求，就可以在 Index 里面新增一条记录。比如，向 "),a("code",[s._v("/user/admin")]),s._v(" 发送请求，就可以新增一条人员记录。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/1'")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"user": "张三",\n"title": "工程师",\n"desc": "数据库管理"\n}\'')]),s._v("\n")])])]),a("p",[s._v("服务器返回的 JSON 对象，会给出 Index、Type、Id、Version 等信息。")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_index"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"result"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"created"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_shards"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"total"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"successful"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"failed"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_seq_no"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_primary_term"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("如果你仔细看，会发现请求路径是"),a("code",[s._v("/user/admin/1")]),s._v("，最后的"),a("code",[s._v("1")]),s._v("是该条记录的 Id。它不一定是数字，任意字符串（比如"),a("code",[s._v("abc")]),s._v("）都可以。")]),s._v(" "),a("p",[s._v("新增记录的时候，也可以不指定 Id，这时要改成 POST 请求。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin'")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"user": "李四",\n"title": "工程师",\n"desc": "系统管理"\n}\'')]),s._v("\n")])])]),a("p",[s._v("上面代码中，向"),a("code",[s._v("/user/admin")]),s._v("发出一个 POST 请求，添加一个记录。这时，服务器返回的 JSON 对象里面，"),a("code",[s._v("_id")]),s._v("字段就是一个随机字符串。")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_index"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WWuoDG8BHwECs7SiYn93"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"result"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"created"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_shards"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"total"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"successful"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"failed"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_seq_no"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_primary_term"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("注意，如果没有先创建 Index（这个例子是"),a("code",[s._v("accounts")]),s._v("），直接执行上面的命令，Elastic 也不会报错，而是直接生成指定的 Index。所以，打字的时候要小心，不要写错 Index 的名称。")]),s._v(" "),a("h4",{attrs:{id:"_3-2-2-删除记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-删除记录"}},[s._v("#")]),s._v(" 3.2.2. 删除记录")]),s._v(" "),a("p",[s._v("删除记录就是发出 "),a("code",[s._v("DELETE")]),s._v(" 请求。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X DELETE "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/2'")]),s._v("\n")])])]),a("h4",{attrs:{id:"_3-2-3-更新记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-更新记录"}},[s._v("#")]),s._v(" 3.2.3. 更新记录")]),s._v(" "),a("p",[s._v("更新记录就是使用 "),a("code",[s._v("PUT")]),s._v(" 请求，重新发送一次数据。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/1'")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"user": "张三",\n"title": "工程师",\n"desc": "超级管理员"\n}\'')]),s._v("\n")])])]),a("h4",{attrs:{id:"_3-2-4-查询记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-查询记录"}},[s._v("#")]),s._v(" 3.2.4. 查询记录")]),s._v(" "),a("p",[s._v("向"),a("code",[s._v("/Index/Type/Id")]),s._v("发出 GET 请求，就可以查看这条记录。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/1?pretty'")]),s._v("\n")])])]),a("p",[s._v("上面代码请求查看 "),a("code",[s._v("/user/admin/1")]),s._v(" 这条记录，URL 的参数 "),a("code",[s._v("pretty=true")]),s._v(" 表示以易读的格式返回。")]),s._v(" "),a("p",[s._v("返回的数据中，"),a("code",[s._v("found")]),s._v(" 字段表示查询成功，"),a("code",[s._v("_source")]),s._v("字段返回原始记录。")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_index"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"found"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_source"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"张三"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"title"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"desc"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"超级管理员"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("如果 Id 不正确，就查不到数据，"),a("code",[s._v("found")]),s._v(" 字段就是 "),a("code",[s._v("false")])]),s._v(" "),a("h4",{attrs:{id:"_3-2-5-查询所有记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-5-查询所有记录"}},[s._v("#")]),s._v(" 3.2.5. 查询所有记录")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("GET")]),s._v(" 方法，直接请求 "),a("code",[s._v("/index/type/_search")]),s._v("，就会返回所有记录。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/_search?pretty'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"took"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timed_out"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_shards"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"successful"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"skipped"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hits"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hits"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_index"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_type"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WWuoDG8BHwECs7SiYn93"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_source"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"李四"')]),s._v(",\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"title"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),s._v(",\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"系统管理"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_index"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_type"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_source"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"张三"')]),s._v(",\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"title"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),s._v(",\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"超级管理员"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("上面代码中，返回结果的 "),a("code",[s._v("took")]),s._v("字段表示该操作的耗时（单位为毫秒），"),a("code",[s._v("timed_out")]),s._v("字段表示是否超时，"),a("code",[s._v("hits")]),s._v("字段表示命中的记录，里面子字段的含义如下。")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("total")]),s._v("：返回记录数，本例是 2 条。")]),s._v(" "),a("li",[a("code",[s._v("max_score")]),s._v("：最高的匹配程度，本例是"),a("code",[s._v("1.0")]),s._v("。")]),s._v(" "),a("li",[a("code",[s._v("hits")]),s._v("：返回的记录组成的数组。")])]),s._v(" "),a("p",[s._v("返回的记录中，每条记录都有一个"),a("code",[s._v("_score")]),s._v("字段，表示匹配的程序，默认是按照这个字段降序排列。")]),s._v(" "),a("h4",{attrs:{id:"_3-2-6-全文搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-6-全文搜索"}},[s._v("#")]),s._v(" 3.2.6. 全文搜索")]),s._v(" "),a("p",[s._v("ES 的查询非常特别，使用自己的"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("查询语法"),a("OutboundLink")],1),s._v("，要求 GET 请求带有数据体。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/_search?pretty'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"query" : { "match" : { "desc" : "管理" }}\n}\'')]),s._v("\n")])])]),a("p",[s._v("上面代码使用 "),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl-match-query.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Match 查询"),a("OutboundLink")],1),s._v("，指定的匹配条件是"),a("code",[s._v("desc")]),s._v('字段里面包含"软件"这个词。返回结果如下。')]),s._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"took"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timed_out"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_shards"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"successful"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"skipped"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hits"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.38200712")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hits"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_index"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_type"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WWuoDG8BHwECs7SiYn93"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.38200712")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_source"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"李四"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"title"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"系统管理"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_index"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_type"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_score"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3487891")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_source"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"张三"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"title"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"工程师"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"超级管理员"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("Elastic 默认一次返回 10 条结果，可以通过"),a("code",[s._v("size")]),s._v("字段改变这个设置，还可以通过"),a("code",[s._v("from")]),s._v("字段，指定位移。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/_search'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n  "query" : { "match" : { "desc" : "管理" }},\n  "from": 1,\n  "size": 1\n}\'')]),s._v("\n")])])]),a("p",[s._v("上面代码指定，从位置 1 开始（默认是从位置 0 开始），只返回一条结果。")]),s._v(" "),a("h4",{attrs:{id:"_3-2-7-逻辑运算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-7-逻辑运算"}},[s._v("#")]),s._v(" 3.2.7. 逻辑运算")]),s._v(" "),a("p",[s._v("如果有多个搜索关键字， Elastic 认为它们是"),a("code",[s._v("or")]),s._v("关系。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/_search'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"query" : { "match" : { "desc" : "软件 系统" }}\n}\'')]),s._v("\n")])])]),a("p",[s._v("上面代码搜索的是"),a("code",[s._v("软件 or 系统")]),s._v("。")]),s._v(" "),a("p",[s._v("如果要执行多个关键词的"),a("code",[s._v("and")]),s._v("搜索，必须使用"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl-bool-query.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("布尔查询"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:9200/user/admin/_search?pretty'")]),s._v("  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n "query": {\n  "bool": {\n   "must": [\n    { "match": { "desc": "管理" } },\n    { "match": { "desc": "超级" } }\n   ]\n  }\n }\n}\'')]),s._v("\n")])])]),a("h2",{attrs:{id:"三、elasticsearch-基本原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、elasticsearch-基本原理"}},[s._v("#")]),s._v(" 三、ElasticSearch 基本原理")]),s._v(" "),a("h3",{attrs:{id:"_2-1-es-写数据过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-es-写数据过程"}},[s._v("#")]),s._v(" 2.1. ES 写数据过程")]),s._v(" "),a("ul",[a("li",[s._v("客户端选择一个 node 发送请求过去，这个 node 就是 "),a("code",[s._v("coordinating node")]),s._v("（协调节点）。")]),s._v(" "),a("li",[a("code",[s._v("coordinating node")]),s._v(" 对 document 进行"),a("strong",[s._v("路由")]),s._v("，将请求转发给对应的 node（有 primary shard）。")]),s._v(" "),a("li",[s._v("实际的 node 上的 "),a("code",[s._v("primary shard")]),s._v(" 处理请求，然后将数据同步到 "),a("code",[s._v("replica node")]),s._v("。")]),s._v(" "),a("li",[a("code",[s._v("coordinating node")]),s._v(" 如果发现 "),a("code",[s._v("primary node")]),s._v(" 和所有 "),a("code",[s._v("replica node")]),s._v(" 都搞定之后，就返回响应结果给客户端。")])]),s._v(" "),a("h3",{attrs:{id:"_2-2-es-读数据过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-es-读数据过程"}},[s._v("#")]),s._v(" 2.2. ES 读数据过程")]),s._v(" "),a("p",[s._v("可以通过 "),a("code",[s._v("doc id")]),s._v(" 来查询，会根据 "),a("code",[s._v("doc id")]),s._v(" 进行 hash，判断出来当时把 "),a("code",[s._v("doc id")]),s._v(" 分配到了哪个 shard 上面去，从那个 shard 去查询。")]),s._v(" "),a("ul",[a("li",[s._v("客户端发送请求到"),a("strong",[s._v("任意")]),s._v("一个 node，成为 "),a("code",[s._v("coordinate node")]),s._v("。")]),s._v(" "),a("li",[a("code",[s._v("coordinate node")]),s._v(" 对 "),a("code",[s._v("doc id")]),s._v(" 进行哈希路由，将请求转发到对应的 node，此时会使用 "),a("code",[s._v("round-robin")]),s._v(" "),a("strong",[s._v("随机轮询算法")]),s._v("，在 "),a("code",[s._v("primary shard")]),s._v(" 以及其所有 replica 中随机选择一个，让读请求负载均衡。")]),s._v(" "),a("li",[s._v("接收请求的 node 返回 document 给 "),a("code",[s._v("coordinate node")]),s._v("。")]),s._v(" "),a("li",[a("code",[s._v("coordinate node")]),s._v(" 返回 document 给客户端。")])]),s._v(" "),a("h3",{attrs:{id:"_2-3-写数据底层原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-写数据底层原理"}},[s._v("#")]),s._v(" 2.3. 写数据底层原理")]),s._v(" "),a("p",[s._v("先写入内存 buffer，在 buffer 里的时候数据是搜索不到的；同时将数据写入 translog 日志文件。")]),s._v(" "),a("p",[s._v("如果 buffer 快满了，或者到一定时间，就会将内存 buffer 数据 "),a("code",[s._v("refresh")]),s._v(" 到一个新的 "),a("code",[s._v("segment file")]),s._v(" 中，但是此时数据不是直接进入 "),a("code",[s._v("segment file")]),s._v(" 磁盘文件，而是先进入 "),a("code",[s._v("os cache")]),s._v(" 。这个过程就是 "),a("code",[s._v("refresh")]),s._v("。")]),s._v(" "),a("p",[s._v("每隔 1 秒钟，es 将 buffer 中的数据写入一个"),a("strong",[s._v("新的")]),s._v(" "),a("code",[s._v("segment file")]),s._v("，每秒钟会产生一个"),a("strong",[s._v("新的磁盘文件")]),s._v(" "),a("code",[s._v("segment file")]),s._v("，这个 "),a("code",[s._v("segment file")]),s._v(" 中就存储最近 1 秒内 buffer 中写入的数据。")]),s._v(" "),a("p",[s._v("但是如果 buffer 里面此时没有数据，那当然不会执行 refresh 操作，如果 buffer 里面有数据，默认 1 秒钟执行一次 refresh 操作，刷入一个新的 segment file 中。")]),s._v(" "),a("p",[s._v("操作系统里面，磁盘文件其实都有一个东西，叫做 "),a("code",[s._v("os cache")]),s._v("，即操作系统缓存，就是说数据写入磁盘文件之前，会先进入 "),a("code",[s._v("os cache")]),s._v("，先进入操作系统级别的一个内存缓存中去。只要 "),a("code",[s._v("buffer")]),s._v(" 中的数据被 refresh 操作刷入 "),a("code",[s._v("os cache")]),s._v("中，这个数据就可以被搜索到了。")]),s._v(" "),a("p",[s._v("为什么叫 es 是"),a("strong",[s._v("准实时")]),s._v("的？ "),a("code",[s._v("NRT")]),s._v("，全称 "),a("code",[s._v("near real-time")]),s._v("。默认是每隔 1 秒 refresh 一次的，所以 es 是准实时的，因为写入的数据 1 秒之后才能被看到。可以通过 es 的 "),a("code",[s._v("restful api")]),s._v(" 或者 "),a("code",[s._v("java api")]),s._v("，"),a("strong",[s._v("手动")]),s._v("执行一次 refresh 操作，就是手动将 buffer 中的数据刷入 "),a("code",[s._v("os cache")]),s._v("中，让数据立马就可以被搜索到。只要数据被输入 "),a("code",[s._v("os cache")]),s._v(" 中，buffer 就会被清空了，因为不需要保留 buffer 了，数据在 translog 里面已经持久化到磁盘去一份了。")]),s._v(" "),a("p",[s._v("重复上面的步骤，新的数据不断进入 buffer 和 translog，不断将 "),a("code",[s._v("buffer")]),s._v(" 数据写入一个又一个新的 "),a("code",[s._v("segment file")]),s._v(" 中去，每次 "),a("code",[s._v("refresh")]),s._v(" 完 buffer 清空，translog 保留。随着这个过程推进，translog 会变得越来越大。当 translog 达到一定长度的时候，就会触发 "),a("code",[s._v("commit")]),s._v(" 操作。")]),s._v(" "),a("p",[s._v("commit 操作发生第一步，就是将 buffer 中现有数据 "),a("code",[s._v("refresh")]),s._v(" 到 "),a("code",[s._v("os cache")]),s._v(" 中去，清空 buffer。然后，将一个 "),a("code",[s._v("commit point")]),s._v(" 写入磁盘文件，里面标识着这个 "),a("code",[s._v("commit point")]),s._v(" 对应的所有 "),a("code",[s._v("segment file")]),s._v("，同时强行将 "),a("code",[s._v("os cache")]),s._v(" 中目前所有的数据都 "),a("code",[s._v("fsync")]),s._v(" 到磁盘文件中去。最后"),a("strong",[s._v("清空")]),s._v(" 现有 translog 日志文件，重启一个 translog，此时 commit 操作完成。")]),s._v(" "),a("p",[s._v("这个 commit 操作叫做 "),a("code",[s._v("flush")]),s._v("。默认 30 分钟自动执行一次 "),a("code",[s._v("flush")]),s._v("，但如果 translog 过大，也会触发 "),a("code",[s._v("flush")]),s._v("。flush 操作就对应着 commit 的全过程，我们可以通过 es api，手动执行 flush 操作，手动将 os cache 中的数据 fsync 强刷到磁盘上去。")]),s._v(" "),a("p",[s._v("translog 日志文件的作用是什么？你执行 commit 操作之前，数据要么是停留在 buffer 中，要么是停留在 os cache 中，无论是 buffer 还是 os cache 都是内存，一旦这台机器死了，内存中的数据就全丢了。所以需要将数据对应的操作写入一个专门的日志文件 "),a("code",[s._v("translog")]),s._v(" 中，一旦此时机器宕机，再次重启的时候，es 会自动读取 translog 日志文件中的数据，恢复到内存 buffer 和 os cache 中去。")]),s._v(" "),a("p",[s._v("translog 其实也是先写入 os cache 的，默认每隔 5 秒刷一次到磁盘中去，所以默认情况下，可能有 5 秒的数据会仅仅停留在 buffer 或者 translog 文件的 os cache 中，如果此时机器挂了，会"),a("strong",[s._v("丢失")]),s._v(" 5 秒钟的数据。但是这样性能比较好，最多丢 5 秒的数据。也可以将 translog 设置成每次写操作必须是直接 "),a("code",[s._v("fsync")]),s._v(" 到磁盘，但是性能会差很多。")]),s._v(" "),a("p",[s._v("实际上你在这里，如果面试官没有问你 es 丢数据的问题，你可以在这里给面试官炫一把，你说，其实 es 第一是准实时的，数据写入 1 秒后可以搜索到；可能会丢失数据的。有 5 秒的数据，停留在 buffer、translog os cache、segment file os cache 中，而不在磁盘上，此时如果宕机，会导致 5 秒的"),a("strong",[s._v("数据丢失")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("总结一下")]),s._v("，数据先写入内存 buffer，然后每隔 1s，将数据 refresh 到 os cache，到了 os cache 数据就能被搜索到（所以我们才说 es 从写入到能被搜索到，中间有 1s 的延迟）。每隔 5s，将数据写入 translog 文件（这样如果机器宕机，内存数据全没，最多会有 5s 的数据丢失），translog 大到一定程度，或者默认每隔 30mins，会触发 commit 操作，将缓冲区的数据都 flush 到 segment file 磁盘文件中。")]),s._v(" "),a("blockquote",[a("p",[s._v("数据写入 segment file 之后，同时就建立好了倒排索引。")])]),s._v(" "),a("h3",{attrs:{id:"_2-4-删除-更新数据底层原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-删除-更新数据底层原理"}},[s._v("#")]),s._v(" 2.4. 删除/更新数据底层原理")]),s._v(" "),a("p",[s._v("如果是删除操作，commit 的时候会生成一个 "),a("code",[s._v(".del")]),s._v(" 文件，里面将某个 doc 标识为 "),a("code",[s._v("deleted")]),s._v(" 状态，那么搜索的时候根据 "),a("code",[s._v(".del")]),s._v(" 文件就知道这个 doc 是否被删除了。")]),s._v(" "),a("p",[s._v("如果是更新操作，就是将原来的 doc 标识为 "),a("code",[s._v("deleted")]),s._v(" 状态，然后新写入一条数据。")]),s._v(" "),a("p",[s._v("buffer 每 refresh 一次，就会产生一个 "),a("code",[s._v("segment file")]),s._v("，所以默认情况下是 1 秒钟一个 "),a("code",[s._v("segment file")]),s._v("，这样下来 "),a("code",[s._v("segment file")]),s._v(" 会越来越多，此时会定期执行 merge。每次 merge 的时候，会将多个 "),a("code",[s._v("segment file")]),s._v(" 合并成一个，同时这里会将标识为 "),a("code",[s._v("deleted")]),s._v(" 的 doc 给"),a("strong",[s._v("物理删除掉")]),s._v("，然后将新的 "),a("code",[s._v("segment file")]),s._v(" 写入磁盘，这里会写一个 "),a("code",[s._v("commit point")]),s._v("，标识所有新的 "),a("code",[s._v("segment file")]),s._v("，然后打开 "),a("code",[s._v("segment file")]),s._v(" 供搜索使用，同时删除旧的 "),a("code",[s._v("segment file")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"_2-5-底层-lucene"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-底层-lucene"}},[s._v("#")]),s._v(" 2.5. 底层 lucene")]),s._v(" "),a("p",[s._v("简单来说，lucene 就是一个 jar 包，里面包含了封装好的各种建立倒排索引的算法代码。我们用 Java 开发的时候，引入 lucene jar，然后基于 lucene 的 api 去开发就可以了。")]),s._v(" "),a("p",[s._v("通过 lucene，我们可以将已有的数据建立索引，lucene 会在本地磁盘上面，给我们组织索引的数据结构。")]),s._v(" "),a("h3",{attrs:{id:"_2-6-倒排索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-倒排索引"}},[s._v("#")]),s._v(" 2.6. 倒排索引")]),s._v(" "),a("p",[s._v("在搜索引擎中，每个文档都有一个对应的文档 ID，文档内容被表示为一系列关键词的集合。例如，文档 1 经过分词，提取了 20 个关键词，每个关键词都会记录它在文档中出现的次数和出现位置。")]),s._v(" "),a("p",[s._v("那么，倒排索引就是"),a("strong",[s._v("关键词到文档")]),s._v(" ID 的映射，每个关键词都对应着一系列的文件，这些文件中都出现了关键词。")]),s._v(" "),a("p",[s._v("举个栗子。")]),s._v(" "),a("p",[s._v("有以下文档：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("DocId")]),s._v(" "),a("th",[s._v("Doc")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("1")]),s._v(" "),a("td",[s._v("谷歌地图之父跳槽 Facebook")])]),s._v(" "),a("tr",[a("td",[s._v("2")]),s._v(" "),a("td",[s._v("谷歌地图之父加盟 Facebook")])]),s._v(" "),a("tr",[a("td",[s._v("3")]),s._v(" "),a("td",[s._v("谷歌地图创始人拉斯离开谷歌加盟 Facebook")])]),s._v(" "),a("tr",[a("td",[s._v("4")]),s._v(" "),a("td",[s._v("谷歌地图之父跳槽 Facebook 与 Wave 项目取消有关")])]),s._v(" "),a("tr",[a("td",[s._v("5")]),s._v(" "),a("td",[s._v("谷歌地图之父拉斯加盟社交网站 Facebook")])])])]),s._v(" "),a("p",[s._v("对文档进行分词之后，得到以下"),a("strong",[s._v("倒排索引")]),s._v("。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("WordId")]),s._v(" "),a("th",[s._v("Word")]),s._v(" "),a("th",[s._v("DocIds")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("1")]),s._v(" "),a("td",[s._v("谷歌")]),s._v(" "),a("td",[s._v("1,2,3,4,5")])]),s._v(" "),a("tr",[a("td",[s._v("2")]),s._v(" "),a("td",[s._v("地图")]),s._v(" "),a("td",[s._v("1,2,3,4,5")])]),s._v(" "),a("tr",[a("td",[s._v("3")]),s._v(" "),a("td",[s._v("之父")]),s._v(" "),a("td",[s._v("1,2,4,5")])]),s._v(" "),a("tr",[a("td",[s._v("4")]),s._v(" "),a("td",[s._v("跳槽")]),s._v(" "),a("td",[s._v("1,4")])]),s._v(" "),a("tr",[a("td",[s._v("5")]),s._v(" "),a("td",[s._v("Facebook")]),s._v(" "),a("td",[s._v("1,2,3,4,5")])]),s._v(" "),a("tr",[a("td",[s._v("6")]),s._v(" "),a("td",[s._v("加盟")]),s._v(" "),a("td",[s._v("2,3,5")])]),s._v(" "),a("tr",[a("td",[s._v("7")]),s._v(" "),a("td",[s._v("创始人")]),s._v(" "),a("td",[s._v("3")])]),s._v(" "),a("tr",[a("td",[s._v("8")]),s._v(" "),a("td",[s._v("拉斯")]),s._v(" "),a("td",[s._v("3,5")])]),s._v(" "),a("tr",[a("td",[s._v("9")]),s._v(" "),a("td",[s._v("离开")]),s._v(" "),a("td",[s._v("3")])]),s._v(" "),a("tr",[a("td",[s._v("10")]),s._v(" "),a("td",[s._v("与")]),s._v(" "),a("td",[s._v("4")])]),s._v(" "),a("tr",[a("td",[s._v("..")]),s._v(" "),a("td",[s._v("..")]),s._v(" "),a("td",[s._v("..")])])])]),s._v(" "),a("p",[s._v("另外，实用的倒排索引还可以记录更多的信息，比如文档频率信息，表示在文档集合中有多少个文档包含某个单词。")]),s._v(" "),a("p",[s._v("那么，有了倒排索引，搜索引擎可以很方便地响应用户的查询。比如用户输入查询 "),a("code",[s._v("Facebook")]),s._v("，搜索系统查找倒排索引，从中读出包含这个单词的文档，这些文档就是提供给用户的搜索结果。")]),s._v(" "),a("p",[s._v("要注意倒排索引的两个重要细节：")]),s._v(" "),a("ul",[a("li",[s._v("倒排索引中的所有词项对应一个或多个文档；")]),s._v(" "),a("li",[s._v("倒排索引中的词项"),a("strong",[s._v("根据字典顺序升序排列")])])]),s._v(" "),a("blockquote",[a("p",[s._v("上面只是一个简单的栗子，并没有严格按照字典顺序升序排列。")])]),s._v(" "),a("h2",{attrs:{id:"elastic-技术栈系列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elastic-技术栈系列"}},[s._v("#")]),s._v(" Elastic 技术栈系列")]),s._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/search/elasticsearch/elasticsearch-ops.html"}},[s._v("ElasticSearch 运维")]),s._v(" - ElasticSearch 安装、配置、命令详解。")],1)]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("官方")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.elastic.co/cn/products/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch 官网"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch Github"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch 官方文档"),a("OutboundLink")],1)])])]),s._v(" "),a("li",[a("strong",[s._v("文章")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/rpm.html#rpm",target:"_blank",rel:"noopener noreferrer"}},[s._v("Install Elasticsearch with RPM"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2017/08/elasticsearch.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.ruanyifeng.com/blog/2017/08/elasticsearch.html"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/es-introduction.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("es-introduction"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/es-write-query-search.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("es-write-query-search"),a("OutboundLink")],1)])])])])])}),[],!1,null,null,null);t.default=r.exports}}]);